<?phpclass RptQcByIB extends ReportData2 {//IB报表    protected $qcBoxModel;    public function __construct(){        $this->qcBoxModel=new QcBoxForm("view");    }    public function fields() {		$list = array(            'city_name'=>array('label'=>Yii::t('app','City'),'width'=>12,'align'=>'C'),			'entry_dt'=>array('label'=>Yii::t('qc','Entry Date'),'width'=>18,'align'=>'C'),            'qc_staff'=>array('label'=>Yii::t('qc','Staff-QC'),'width'=>30,'align'=>'L'),			'job_staff'=>array('label'=>Yii::t('qc','Resp. Staff'),'width'=>30,'align'=>'L'),//			'team'=>array('label'=>Yii::t('qc','Team'),'width'=>22,'align'=>'C'),//			'month'=>array('label'=>Yii::t('qc','Month'),'width'=>10,'align'=>'C'),//			'input_dt'=>array('label'=>Yii::t('qc','Input Date'),'width'=>18,'align'=>'C'),			'company_name'=>array('label'=>Yii::t('qc','Customer'),'width'=>30,'align'=>'L'),			'service_dt'=>array('label'=>Yii::t('qc','Service Date'),'width'=>18,'align'=>'L'),            'qc_dt'=>array('label'=>Yii::t('qc','QC Date'),'width'=>18,'align'=>'C'),            'qc_result'=>array('label'=>Yii::t('qc','QC Result'),'width'=>15,'align'=>'C'),            'result_below'=>array('label'=>Yii::t('qc','Below 70**'),'width'=>15,'align'=>'C'),            'cust_sfn'=>array('label'=>Yii::t('qc','Customer satisfaction'),'width'=>15,'align'=>'C'),            'cust_comment'=>array('label'=>Yii::t('qc','Customer Comment'),'width'=>30,'align'=>'L'),            'remarks'=>array('label'=>Yii::t('qc','Remarks'),'width'=>40,'align'=>'L'),			//'service_type'=>array('label'=>Yii::t('qc','Service Type'),'width'=>15,'align'=>'C'),			//'service_score'=>array('label'=>Yii::t('qc','Service Score'),'width'=>15,'align'=>'C'),			//'cust_score'=>array('label'=>Yii::t('qc','Customer Score'),'width'=>15,'align'=>'C'),			//'env_grade'=>array('label'=>Yii::t('qc','Env. Grade'),'width'=>20,'align'=>'C'),			//'cust_sign'=>array('label'=>Yii::t('qc','Signature'),'width'=>22,'align'=>'L'),			//'improve'=>array('label'=>Yii::t('qc','Need to Improve'),'width'=>40,'align'=>'L'),			//'praise'=>array('label'=>Yii::t('qc','Praise'),'width'=>40,'align'=>'L'),            'bool'=>array('label'=>Yii::t('enquiry','Bool'),'width'=>40,'align'=>'L'),		);		foreach ($this->qcBoxModel->ib_fields as $topKey=>$rows){		    foreach ($rows["list"] as $row){		        $list[$row["name"]]=array('label'=>Yii::t('qc',$row["title"]),'width'=>26,'align'=>'L');            }        }		return $list;	}    public function header_structure() {        $list = array(            'city_name',            'entry_dt',            'qc_staff',            'job_staff',            'company_name',            'service_dt',            'qc_dt',            'qc_result',            'result_below',            'cust_sfn',            'cust_comment',            'remarks',            'bool',        );        foreach ($this->qcBoxModel->ib_fields as $topKey=>$rows){            $temp=array(                'label'=>Yii::t('qc',$rows["name"]),                'child'=>array(),            );            foreach ($rows["list"] as $row){                $temp['child'][]=$row["name"];            }            $list[]=$temp;        }        return $list;    }	public function retrieveData() {//		$city = Yii::app()->user->city();		$city = $this->criteria->city;        if(!General::isJSON($city)){            $city_allow = strpos($city,"'")!==false?$city:"'{$city}'";        }else{            $city_allow = json_decode($city,true);            $city_allow = "'".implode("','",$city_allow)."'";        }		$sql = "select a.*,(b.field_blob<>'' and c.field_blob<>'') as bool					from swo_qc a 					left outer join swo_qc_info b on a.id=b.qc_id and b.field_id='sign_cust'					left outer join swo_qc_info c on a.id=c.qc_id and c.field_id='sign_qc'		";		$where = "where a.city in ($city_allow) and a.service_type='IB' ";		if (isset($this->criteria)) {			if (isset($this->criteria->start_dt))				$where .= (($where=='where') ? " " : " and ")."entry_dt>='".General::toDate($this->criteria->start_dt)."'";			if (isset($this->criteria->end_dt))				$where .= (($where=='where') ? " " : " and ")."entry_dt<='".General::toDate($this->criteria->end_dt)."'";		}		if ($where!='where') $sql .= $where;			$sql .= " order by a.city,entry_dt desc";		$rows = Yii::app()->db->createCommand($sql)->queryAll();		if (count($rows) > 0) {			foreach ($rows as $row) {                $temp = array();			    $detailRows=Yii::app()->db->createCommand()->select("field_id,field_value,if(field_blob<>'',1,0) as bool")->from("swo_qc_info")                    ->where("qc_id=:id",array(":id"=>$row["id"]))->queryAll();			    if($detailRows){                    foreach ($detailRows as $detailRow){                        if(in_array($detailRow['field_id'],array("sign_cust","sign_qc"))){                            $temp[$detailRow['field_id']]=$detailRow['bool'];                        }else{                            $temp[$detailRow['field_id']]=$detailRow['field_value'];                        }                    }                }                $temp['sign_cust'] = isset($temp['sign_cust'])?$temp['sign_cust']:0;                $temp['sign_qc'] = isset($temp['sign_qc'])?$temp['sign_qc']:0;                foreach ($this->qcBoxModel->ib_fields as $topKey=>$topRows){                    foreach ($topRows["list"] as $topRow){                        $temp[$topRow["name"]]=isset($temp[$topRow["name"]."_remark"])?$temp[$topRow["name"]."_remark"]:"";                    }                }                $temp['city_name'] = General::getCityName($row["city"]);				$temp['entry_dt'] = General::toDate($row['entry_dt']);                $temp['qc_staff'] = trim($row['qc_staff']);				$temp['job_staff'] = trim($row['job_staff']);				$temp['company_name'] = trim($row['company_name']);                $temp['qc_dt'] = General::toDate($row['qc_dt']);                $temp['qc_result'] = $row['qc_result'];                $temp['result_below'] = (is_numeric($row['qc_result']))	? (($row['qc_result'] < 70) ? '**' : '') : '';                $temp['cust_comment'] = $row['cust_comment'];                $temp['remarks'] = $row['remarks'];                $temp['bool'] = $temp['sign_cust']==1&&$temp['sign_qc']==1?"已完成":"未完成";				$this->data[] = $temp;			}		}		return true;	}	public function getReportName() {		$city_name = isset($this->criteria) ? ' - '.General::getCityNameForList($this->criteria->city) : '';		return parent::getReportName();	}}?>